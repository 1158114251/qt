#!/usr/bin/perl -w

my $objects_dir = $ARGV[0];
my $deffile = $ARGV[1];
my $dllFile = $ARGV[2];
my $target = $ARGV[3];

my @exports;
open (HANDLE, "< $deffile") or die ("Could not open $deffile");
while (<HANDLE>) {
    while (/(_Z[^ ]+)/xg) {
        push (@exports, $1);
    }
}
close(HANDLE);

my @ordinalfiles;

for (my $c = 0; $c < scalar(@exports); $c++) {
    my $symbol = $exports[$c];
    my $genstubs;
    open ($genstubs, "| winewrapper genstubs.exe") or die ("Could not execute genstubs");
    print ($genstubs "$objects_dir/ordinal-$c.o $symbol #<DLL>$dllFile#<\\DLL>$c\n");
    push (@ordinalfiles, "$objects_dir/ordinal-$c.o");
    close ($genstubs);
}

my $via;
open ($via, "> $objects_dir/input.via") or die("Could not open $objects_dir/input.via");
print ($via join("\n", @ordinalfiles));
close($via);

my $result = system("armar --create $target --via $objects_dir/input.via");
die("Could not execute armar") if ($result);

exit 0
