# qt-%QT_VERSION%
env         releaseLocation    "http://tirion.troll.no/~qt/packages/%QT_VERSION%"

#extracts the package to buildDir
extract     dest               "qtsources"
Section EXTRACT
# qt-%QT_VERSION%
extract     extUnpack          "qt-embedded-wince-commercial-src-%QT_VERSION%.zip"
# This is a little bit hacky: The eval patches unzip to qt-win... not to qt-wince
# Thus we keep extracting to that directory and copy it over to our target afterwards
extract     src                "qt-win-commercial-src-%QT_VERSION%"
extract     extPatch           "qt-win-evalpatches-src-%QT_VERSION%.zip"
extract     src                "qt-wince-commercial-src-%QT_VERSION%"
#delete line with "activeqt" in examples.pro file (don't build this)
delete      line               "qtsources\examples\examples.pro"  "activeqt"
SectionEnd

Section GETFILES
copy        extsync            debugext
SectionEnd


#build the WIN32 binaries
build       begin              vs2008    "build_vs2008_ce_win32_evaluation_________________PADDING_________________"
Section CONFIGUREWIN32
build       shadowconfigure    "qtsources" "-confirm-license -no-webkit -no-phonon -qt-libpng -qt-libjpeg -no-openssl -no-incredibuild-xge -D QT_EVAL"
SectionEnd
Section BUILDWIN32
build       bin                sub-src
build       binInDir           "tools"
SectionEnd
build       finish

#build the WM50 binaries
build       begin              vs2008    "build_vs2008_ce_wm50_evaluation_________________PADDING_________________"
Section CONFIGUREWM50
build       shadowconfigure    "qtsources" "-confirm-license -xplatform wincewm50pocket-msvc2008 -no-openssl -no-incredibuild-xge -D QT_EVAL"
SectionEnd
Section BUILDWM50
build       setcepaths         "wincewm50pocket-msvc2008"
build       bin                sub-src
SectionEnd
build       finish

#build the ssdk50x86 binaries
build       begin              vs2008    "build_vs2008_ce_ssdk50x86_evaluation_________________PADDING_________________"
Section CONFIGURESSDK50X86
build       shadowconfigure    "qtsources" "-confirm-license -xplatform wince50standard-x86-msvc2008 -no-openssl -no-incredibuild-xge -D QT_EVAL"
SectionEnd
Section BUILDSSDK50X86
build       setcepaths         "wince50standard-x86-msvc2008"
build       bin                sub-src
SectionEnd
build       finish

# organize release files
Section ORGANIZE
delete      dir                "release_vs2008_ce_evaluation"
copy        dest               "release_vs2008_ce_evaluation"

# copy sources to "qtsources"
copy        src                "qtsources"
delete      dir                "release_vs2008_ce_evaluation\qtsources"
copy        dest               "release_vs2008_ce_evaluation\qtsources"
copy        all                "*"
# NOTE: The eval package must not contain sources. Thus we can only provide
#       the binary builds we have to potential customers.
delete      destdir            "src"
delete      destdir            "tools"
delete      destdir            "qmake"
delete      destdir            "utils"
delete      file               "configure.exe"
copy        dest               "qtsources"
copy        syncqt

# copy WIN32 binaries
copy        src                "build_vs2008_ce_win32_evaluation_________________PADDING_________________"
delete      dir                "release_vs2008_ce_evaluation\win32binaries"
copy        dest               "release_vs2008_ce_evaluation\win32binaries"
copy        files              "bin\*"                 "bin\"
copy        files              "lib\*.pdb"             "bin\"
#copy        files              "include\*"             "include\"
copy        files              "lib\*.prl"             "lib\"
copy        files              "lib\*.lib"             "lib\"
copy        files              "mkspecs\*"             "mkspecs\"
copy        files              "plugins\*"             "plugins\"
copy        file               "include\Qt\qconfig.h"
copy        file               "src\corelib\global\qconfig.h"
copy        file               ".qmake.cache"
# copy header files
copy        src                "qtsources\include"
copy        dest               "release_vs2008_ce_evaluation\win32binaries\include"
copy        all                "*"

copy        src                "release_vs2008_ce_evaluation\qtsources\doc\html"
copy        dest               "release_vs2008_ce_evaluation\win32binaries\doc\html"
copy        all                "*"
copy        src                "release_vs2008_ce_evaluation\qtsources\doc\qch"
copy        dest               "release_vs2008_ce_evaluation\win32binaries\doc\qch"
copy        all                "*"
delete      dir                "release_vs2008_ce_evaluation\qtsources\doc\html"
#copy        all                "qch"
delete      dir                "release_vs2008_ce_evaluation\qtsources\doc\qch"

# copy WM50 binaries
copy        src                "build_vs2008_ce_wm50_evaluation_________________PADDING_________________"
delete      dir                "release_vs2008_ce_evaluation\wm50binaries"
copy        dest               "release_vs2008_ce_evaluation\wm50binaries"
copy        files              "bin\*"                 "bin\"
#copy        files              "include\*"             "include\"
copy        files              "lib\*.prl"             "lib\"
copy        files              "lib\*.lib"             "lib\"
copy        files              "lib\*.pdb"             "lib\"
copy        files              "lib\*.dll"             "lib\"
copy        files              "mkspecs\*"             "mkspecs\"
copy        files              "plugins\*"             "plugins\"
copy        file               "include\Qt\qconfig.h"
copy        file               "src\corelib\global\qconfig.h"
copy        file               ".qmake.cache"
# copy header files
copy        src                "qtsources\include"
copy        dest               "release_vs2008_ce_evaluation\wm50binaries\include"
copy        all                "*"

# copy ssdk50x86 binaries
copy        src                "build_vs2008_ce_ssdk50x86_evaluation_________________PADDING_________________"
delete      dir                "release_vs2008_ce_evaluation\ssdk50x86binaries"
copy        dest               "release_vs2008_ce_evaluation\ssdk50x86binaries"
copy        files              "bin\*"                 "bin\"
#copy        files              "include\*"             "include\"
copy        files              "lib\*.prl"             "lib\"
copy        files              "lib\*.lib"             "lib\"
copy        files              "lib\*.pdb"             "lib\"
copy        files              "lib\*.dll"             "lib\"
copy        files              "mkspecs\*"             "mkspecs\"
copy        files              "plugins\*"             "plugins\"
copy        file               "include\Qt\qconfig.h"
copy        file               "src\corelib\global\qconfig.h"
copy        file               ".qmake.cache"
# copy header files
copy        src                "qtsources\include"
copy        dest               "release_vs2008_ce_evaluation\ssdk50x86binaries\include"
copy        all                "*"

SectionEnd

Section NSIS
# general installer options
installer   begin              "Qt Evaluation for Windows CE"
installer   version            "%QT_VERSION%"
installer   welcometitle       "Welcome to Qt for Windows CE"
installer   finishtitle        "Completing Qt for Windows CE"
installer   output             "c:\iwmake\qt-embedded-wince-eval-%QT_VERSION%-vs2008.exe"
installer   startmenu          "Qt for Windows CE by Nokia v%QT_VERSION% (Eval. VS2008)"

installer   enable             component_page
installer   enable             directory_page
installer   enable             startmenu_page

installer   instdir            msvc     0     "Qt Installation Directory"

installer   readmefunction     "Show Documentation"

# ### FIXME: Use start page as soon as assistant allows you to do so previously to loading documentation.
# installer   readmestartpage    "qthelp://com.trolltech.qt.440/qdoc/wince-with-qt-introduction.html"

# license checking
installer   module             licensecheck
installer   defineDir          licensecheck    licenseDir   "release_vs2008_ce_evaluation\qtsources"
installer   define             licensecheck    productlist  "UnsupportedEvaluation|SupportedEvaluation|FullSourceEvaluation"
installer   define             licensecheck    wince

# ### FIXME: Remove once we have proper licenses
#installer   licenseFile        "%IWMAKE_ROOT%\LICENSE.PREVIEW.COMMERCIAL"

# msvc options
installer   module             msvc
installer   makeFileList       msvc     "release_vs2008_ce_evaluation"
#installer   buildDir           msvc     "build_vs2008_ce_win32_evaluation_________________PADDING_________________"
installer   buildDir           msvc     "qtsources"
installer   defineDir          msvc     qtsourcetree              "qtsources"
installer   define             msvc     qtsourceinstalldirname    "qtsources"
installer   defineDir          msvc     win32buildtree            "build_vs2008_ce_win32_evaluation_________________PADDING_________________"
installer   define             msvc     win32buildinstalldirname  "win32binaries"
installer   defineDir          msvc     wm50buildtree             "build_vs2008_ce_wm50_evaluation_________________PADDING_________________"
installer   define             msvc     wm50buildinstalldirname   "wm50binaries"
installer   define             msvc     wm50sdk                   "wincewm50pocket-msvc2008"
installer   define             msvc     wm50versionpretty         "Windows Mobile 5 Pocket"
installer   defineDir          msvc     ssdk50x86buildtree           "build_vs2008_ce_ssdk50x86_evaluation_________________PADDING_________________"
installer   define             msvc     ssdk50x86buildinstalldirname "ssdk50x86binaries"
installer   define             msvc     ssdk50x86sdk                 "wince50standard-x86-msvc2008"
installer   define             msvc     ssdk50x86versionpretty       "WinCE standard SDK 5 x86"
installer   define             msvc     vs2008
#installer   define             msvc     skippatchlicenseinformation

installer   module             evaluation
installer   module             registeruiext

# compile the package
installer   compile
installer   sign
SectionEnd
