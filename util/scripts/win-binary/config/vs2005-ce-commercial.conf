# qt-%QT_VERSION%
env		releaseLocation		"http://tirion.troll.no/~qt/packages/%QT_VERSION%"

#extracts the package to buildDir
extract     dest               "qtsources"
Section EXTRACT
# qt-%QT_VERSION%
extract     extUnpack          "qt-embedded-wince-commercial-src-%QT_VERSION%.zip"
#delete line with "activeqt" in examples.pro file (don't build this)
delete      line               "qtsources\examples\examples.pro"  "activeqt"

SectionEnd

#build the WIN32 binaries
build       begin              vs2005    "build_vs2005_ce_win32_commercial_________________PADDING_________________"
Section CONFIGUREWIN32
build       shadowconfigure    "qtsources" "-confirm-license -no-webkit -no-phonon -qt-libpng -qt-libjpeg -no-openssl -no-incredibuild-xge"
SectionEnd
Section BUILDWIN32
build       bin                sub-src
build       binInDir           "tools"
SectionEnd
build       finish

#build the WM50 binaries
build       begin              vs2005    "build_vs2005_ce_wm50_commercial_________________PADDING_________________"
Section CONFIGUREWM50
build       shadowconfigure    "qtsources" "-confirm-license -xplatform wincewm50pocket-msvc2005 -no-openssl -no-incredibuild-xge"
SectionEnd
Section BUILDWM50
build       setcepaths         "wincewm50pocket-msvc2005"
build       bin                sub-src
SectionEnd
build       finish

#build the ssdk50x86 binaries
build       begin              vs2005    "build_vs2005_ce_ssdk50x86_commercial_________________PADDING_________________"
Section CONFIGURESSDK50X86
build       shadowconfigure    "qtsources" "-confirm-license -xplatform wince50standard-x86-msvc2005 -no-openssl -no-incredibuild-xge"
SectionEnd
Section BUILDSSDK50X86
build       setcepaths         "wince50standard-x86-msvc2005"
build       bin                sub-src
SectionEnd
build       finish

# organize release files
Section ORGANIZE
delete      dir                "release_vs2005_ce_commercial"
copy        dest               "release_vs2005_ce_commercial"

# copy sources to "qtsources"
copy        src                "qtsources"
delete      dir                "release_vs2005_ce_commercial\qtsources"
copy        dest               "release_vs2005_ce_commercial\qtsources"
copy        all                "*"

# copy WIN32 binaries
copy        src                "build_vs2005_ce_win32_commercial_________________PADDING_________________"
delete      dir                "release_vs2005_ce_commercial\win32binaries"
copy        dest               "release_vs2005_ce_commercial\win32binaries"
copy        files              "bin\*"                 "bin\"
copy        files              "lib\*.pdb"             "bin\"
copy        files              "include\*"             "include\"
copy        files              "lib\*.prl"             "lib\"
copy        files              "lib\*.lib"             "lib\"
copy        files              "mkspecs\*"             "mkspecs\"
copy        files              "plugins\*"             "plugins\"
copy        file               "src\corelib\global\qconfig.h"
copy        file               ".qmake.cache"

copy        src                "release_vs2005_ce_commercial\qtsources\doc\html"
copy        dest               "release_vs2005_ce_commercial\win32binaries\doc\html"
copy        all                "*"
copy        src                "release_vs2005_ce_commercial\qtsources\doc\qch"
copy        dest               "release_vs2005_ce_commercial\win32binaries\doc\qch"
copy        all                "*"
delete      dir                "release_vs2005_ce_commercial\qtsources\doc\html"
#copy        all                "qch"
delete      dir                "release_vs2005_ce_commercial\qtsources\doc\qch"

# copy WM50 binaries
copy        src                "build_vs2005_ce_wm50_commercial_________________PADDING_________________"
delete      dir                "release_vs2005_ce_commercial\wm50binaries"
copy        dest               "release_vs2005_ce_commercial\wm50binaries"
copy        files              "bin\*"                 "bin\"
copy        files              "include\*"             "include\"
copy        files              "lib\*.prl"             "lib\"
copy        files              "lib\*.lib"             "lib\"
copy        files              "lib\*.pdb"             "lib\"
copy        files              "lib\*.dll"             "lib\"
copy        files              "mkspecs\*"             "mkspecs\"
copy        files              "plugins\*"             "plugins\"
copy        file               "src\corelib\global\qconfig.h"
copy        file               ".qmake.cache"

# copy ssdk50x86 binaries
copy        src                "build_vs2005_ce_ssdk50x86_commercial_________________PADDING_________________"
delete      dir                "release_vs2005_ce_commercial\ssdk50x86binaries"
copy        dest               "release_vs2005_ce_commercial\ssdk50x86binaries"
copy        files              "bin\*"                 "bin\"
copy        files              "include\*"             "include\"
copy        files              "lib\*.prl"             "lib\"
copy        files              "lib\*.lib"             "lib\"
copy        files              "lib\*.pdb"             "lib\"
copy        files              "lib\*.dll"             "lib\"
copy        files              "mkspecs\*"             "mkspecs\"
copy        files              "plugins\*"             "plugins\"
copy        file               "src\corelib\global\qconfig.h"
copy        file               ".qmake.cache"

SectionEnd

Section NSIS
# general installer options
installer   begin              "Qt for Windows CE Commercial"
installer   version            "%QT_VERSION%"
installer   welcometitle       "Welcome to Qt for Windows CE"
installer   finishtitle        "Completing Qt for Windows CE"
installer   output             "c:\iwmake\qt-embedded-wince-commercial-%QT_VERSION%-vs2005.exe"
installer   startmenu          "Qt for Windows CE by Nokia v%QT_VERSION% (VS2005)"

installer   enable             component_page
installer   enable             directory_page
installer   enable             startmenu_page

installer   instdir            msvc     0     "Qt Installation Directory"

installer   readmefunction     "Show Documentation"
# ### FIXME: Use start page as soon as assistant allows you to do so previously to loading documentation.
# installer   readmestartpage    "qthelp://com.trolltech.qt.440/qdoc/wince-with-qt-introduction.html"

# license checking
installer   module             licensecheck
installer   defineDir          licensecheck    licenseDir   "release_vs2005_ce_commercial\qtsources"
installer   define             licensecheck    productlist  "Universal|Desktop|DesktopLight|Console|FullSourceEvaluation|Academic|Educational"
installer   define             licensecheck    wince

#installer   licenseFile        "%IWMAKE_ROOT%\LICENSE.PREVIEW.COMMERCIAL"

installer   module             registeruiext

# msvc options
installer   module             msvc
installer   makeFileList       msvc     "release_vs2005_ce_commercial"
installer   buildDir           msvc     "build_vs2005_ce_win32_commercial_________________PADDING_________________"
installer   defineDir          msvc     qtsourcetree              "qtsources"
installer   define             msvc     qtsourceinstalldirname    "qtsources"
installer   defineDir          msvc     win32buildtree            "build_vs2005_ce_win32_commercial_________________PADDING_________________"
installer   define             msvc     win32buildinstalldirname  "win32binaries"
installer   defineDir          msvc     wm50buildtree             "build_vs2005_ce_wm50_commercial_________________PADDING_________________"
installer   define             msvc     wm50buildinstalldirname   "wm50binaries"
installer   define             msvc     wm50sdk                   "wincewm50pocket-msvc2005"
installer   define             msvc     wm50versionpretty         "Windows Mobile 5 Pocket"
installer   defineDir          msvc     ssdk50x86buildtree           "build_vs2005_ce_ssdk50x86_commercial_________________PADDING_________________"
installer   define             msvc     ssdk50x86buildinstalldirname "ssdk50x86binaries"
installer   define             msvc     ssdk50x86sdk                 "wince50standard-x86-msvc2005"
installer   define             msvc     ssdk50x86versionpretty       "WinCE standard SDK 5 x86"
installer   define             msvc     vs2005
#installer   define             msvc     skippatchlicenseinformation

# compile the package
installer   compile
installer   sign
SectionEnd
